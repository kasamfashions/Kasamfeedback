<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kasam Fashion Store Feedback</title>
    <!-- Favicon -->
    <link 
  rel="icon" 
  type="image/png" 
  href="https://raw.githubusercontent.com/kasamfashions/Kasamfeedback/2f0b8e0d7cd18cafa3aec383b55d6d884258d293/Feedback.png" 
/>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Montserrat', sans-serif;
      }
      h1, h2, h3, .serif-font {
        font-family: 'Playfair Display', serif;
      }
      .glass-panel {
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      .animate-float {
        animation: float 6s ease-in-out infinite;
      }
      @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
      }
      .animate-blob {
        animation: blob 7s infinite;
      }
      @keyframes blob {
        0% { transform: translate(0px, 0px) scale(1); }
        33% { transform: translate(30px, -50px) scale(1.1); }
        66% { transform: translate(-20px, 20px) scale(0.9); }
        100% { transform: translate(0px, 0px) scale(1); }
      }
      .animation-delay-2000 {
        animation-delay: 2s;
      }
      .animation-delay-4000 {
        animation-delay: 4s;
      }
      /* Custom Scrollbar for admin panels */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1; 
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #d1d5db; 
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #9ca3af; 
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.1/client",
    "react-dom": "https://aistudiocdn.com/react-dom@^19.2.1",
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.556.0",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.31.0",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js",
    "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"
  }
}
</script>
</head>
  <body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useMemo } from 'react';
      import ReactDOM from 'react-dom/client';
      import { 
        Loader2, ShoppingBag, ArrowRight, Lock, MapPin, X, Plus, 
        BarChart3, Settings, Smartphone, Frame, Car, Tv, Newspaper, 
        Users, Store, Scroll, Megaphone, MessageCircle, CheckCircle2,
        ChevronDown, Download, Calendar, FileText, LogOut, Home,
        LayoutDashboard, Trash2, User, MessageSquare, RefreshCw,
        Copy, Check
      } from 'lucide-react';
      import { GoogleGenAI } from "@google/genai";
      import { initializeApp } from 'firebase/app';
      import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, onSnapshot } from 'firebase/firestore';

      // --- FIREBASE CONFIGURATION ---
      // Replace with your actual Firebase project configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBExPCqUUq1Br3CT7m-SRvWYzFRMirCRIU", 
        authDomain: "customer-feedback-901f9.firebaseapp.com",
        projectId: "customer-feedback-901f9", 
        storageBucket: "customer-feedback-901f9.firebasestorage.app",
        messagingSenderId: "375164981290",
        appId: "1:375164981290:web:f69fe49e1fc18b4e103353",
        measurementId: "G-7BJZE8R165"
      };

      let db = null;
      if (firebaseConfig.apiKey) {
        try {
          const app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          console.log("Firebase initialized successfully");
        } catch (error) {
          console.error("Firebase initialization failed:", error);
        }
      }

      // --- GOOGLE SHEETS CONFIG ---
      
      /* 
       * !!! IMPORTANT: GOOGLE APPS SCRIPT SETUP !!!
       * 
       * 1. Go to https://script.google.com/
       * 2. Paste the 'doGet' and 'doPost' code provided in the thought instructions.
       * 3. Deploy as Web App -> Execute as: "Me" -> Who has access: "Anyone"
       * 4. Paste the URL below.
       */
      const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbxJlQ9f4y7ZmBG6kZhZ9sAjPF08_LbOJ32tBSDHhmrglEOX1bYwP6rFJniCdpkvQRI/exec'; 

      const APPS_SCRIPT_CODE = `function doPost(e) {
  var lock = LockService.getScriptLock();
  lock.tryLock(10000);

  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    
    // Create headers if sheet is empty
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(["ID", "Customer Name", "Location ID", "Location Name", "Source ID", "Source Label", "Other Details", "Timestamp", "Date", "Time"]);
    }

    var data = JSON.parse(e.postData.contents);
    var d = new Date(data.timestamp);

    // Append data
    sheet.appendRow([
      "'"+data.id, 
      data.customerName, 
      data.locationId, 
      data.locationName, 
      data.sourceId,
      data.sourceLabel, 
      data.otherDetails, 
      data.timestamp,
      d.toLocaleDateString(), 
      d.toLocaleTimeString()
    ]);

    return ContentService.createTextOutput(JSON.stringify({ "result": "success" }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (e) {
    return ContentService.createTextOutput(JSON.stringify({ "result": "error", "error": e.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

function doGet(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var rows = sheet.getDataRange().getValues();
  var data = [];
  
  // Start from row index 1 (skip header)
  for (var i = 1; i < rows.length; i++) {
    var row = rows[i];
    data.push({
      id: row[0],
      customerName: row[1],
      locationId: row[2],
      locationName: row[3],
      sourceId: row[4],
      sourceLabel: row[5],
      otherDetails: row[6],
      timestamp: row[7]
    });
  }
  
  // Return JSON (Reverse to show newest first)
  return ContentService.createTextOutput(JSON.stringify(data.reverse()))
    .setMimeType(ContentService.MimeType.JSON);
}`;

      // --- CONSTANTS ---

      const FEEDBACK_OPTIONS = [
        { id: 'digital', label: 'Digital Marketing (FB/Insta)', icon: Smartphone, colorClass: 'from-pink-500 to-rose-500' },
        { id: 'hoardings', label: 'Hoardings', icon: Frame, colorClass: 'from-amber-500 to-orange-500' },
        { id: 'auto_ads', label: 'Auto Ads', icon: Car, colorClass: 'from-yellow-400 to-amber-500' },
        { id: 'cable_tv', label: 'Cable TV Ads', icon: Tv, colorClass: 'from-blue-500 to-cyan-500' },
        { id: 'pamphlets', label: 'Pamphlets Distribution', icon: Newspaper, colorClass: 'from-green-500 to-emerald-500' },
        { id: 'friends', label: 'Friends & Relatives', icon: Users, colorClass: 'from-purple-500 to-violet-500' },
        { id: 'store_view', label: 'Store View / Walk-in', icon: Store, colorClass: 'from-red-500 to-pink-600' },
        { id: 'paper_inserts', label: 'Paper Inserts', icon: Scroll, colorClass: 'from-slate-500 to-gray-600' },
        { id: 'street', label: 'Street Activities', icon: Megaphone, colorClass: 'from-teal-500 to-green-500' },
        { id: 'other', label: 'Others', icon: MessageCircle, colorClass: 'from-indigo-500 to-blue-600' },
      ];

      // --- SERVICES ---

      const useLocations = () => {
        const [locations, setLocations] = useState([]);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
          if (!db) {
            setLocations([{ id: 'demo-1', name: 'Demo Location (Firebase Disconnected)' }]);
            setLoading(false);
            return;
          }

          const q = query(collection(db, "locations"), orderBy("name"));
          const unsubscribe = onSnapshot(q, (snapshot) => {
            const locs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setLocations(locs);
            setLoading(false);
          });
          return () => unsubscribe();
        }, []);

        const addLocation = async (name) => {
          if (!db) return;
          try { await addDoc(collection(db, "locations"), { name }); } catch (e) { console.error("Error adding location", e); }
        };

        const deleteLocation = async (id) => {
          if (!db) return;
          try { await deleteDoc(doc(db, "locations", id)); } catch (e) { console.error("Error deleting location", e); }
        };

        return { locations, loading, addLocation, deleteLocation };
      };

      // --- FIXED GOOGLE SHEETS SERVICES ---

      // Writing data: Uses no-cors (opaque) because we just want to send data and not fail on CORS checks
      const saveToGoogleSheet = async (data) => {
        try {
          // Use 'no-cors' mode for POST to avoid CORS preflight issues on some browsers/GAS setups
          // Note: We won't know if it truly succeeded based on response status in no-cors, 
          // but it will submit the data.
          await fetch(GOOGLE_SHEET_URL, {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
          return true;
        } catch (error) {
          console.error("Sheet sync failed", error);
          return false;
        }
      };

      // Reading data: MUST use standard CORS.
      // If this fails, it is 99% likely because the Script is not deployed as "Who has access: Anyone"
      const fetchFromGoogleSheet = async () => {
        try {
          // Add cache busting param
          const url = `${GOOGLE_SHEET_URL}?v=${Date.now()}`;
          
          const response = await fetch(url, {
            method: 'GET',
            // Do NOT use 'no-cors' here, or you cannot read the JSON body
            redirect: 'follow' 
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          console.log("Fetched data:", data); // Debugging log
          return Array.isArray(data) ? data : [];
        } catch (error) {
          console.error("Failed to fetch from sheets. CHECK GAS PERMISSIONS (Must be 'Anyone').", error);
          return [];
        }
      };

      // 3. AI Service
      const generateThankYouMessage = async (sourceLabel) => {
        let apiKey = '';
        try { if (typeof process !== 'undefined' && process.env) apiKey = process.env.API_KEY; } catch(e) {}

        if (!apiKey) return "Thank you! Your style is amazing.";
        
        const ai = new GoogleGenAI({ apiKey });
        try {
          const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: `Generate a short, witty, fashion-themed thank you message (max 15 words) for a customer who found our store via "${sourceLabel}".`,
          });
          return response.text.trim();
        } catch (error) {
          return "Thank you so much! Your impeccable taste led you to the right place.";
        }
      };

      // 4. CSV Download
      const downloadCSV = (data) => {
        if (!data || !data.length) return;
        const headers = ["Date", "Time", "Customer Name", "Location", "Source", "Details"];
        const csvContent = [
          headers.join(","),
          ...data.map(row => {
            const d = new Date(row.timestamp);
            return [
              d.toLocaleDateString(),
              d.toLocaleTimeString(),
              `"${row.customerName || ''}"`,
              `"${row.locationName || ''}"`,
              `"${row.sourceLabel || ''}"`,
              `"${row.otherDetails || ''}"`
            ].join(",");
          })
        ].join("\n");

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `kasam_feedback_export_${Date.now()}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      // --- UI COMPONENTS ---

      const Logo = ({ className }) => (
 <div className={`flex items-center gap-1 ${className}`}>
<div className="">
<img 
 src="https://github.com/kasamfashions/Kasamfeedback/blob/afb9ef3d41588301e6a15396d858b92cbdcbf887/LOGO(2)%20(2).png" 
 alt="KASAM FASHIONS Logo" 
  className="h-8 w-8 object-contain"/>
</div>
 <div>
 <h2 className="font-bold text-lg serif-font">KASAM FASHIONS</h2>
</div>
 </div>
 );
      const OptionCard = ({ option, isSelected, onClick }) => {
        const Icon = option.icon;
        return (
          <button
            onClick={onClick}
            className={`
              relative group overflow-hidden rounded-2xl p-6 transition-all duration-300 ease-out
              flex flex-col items-center justify-center gap-3 text-center
              border-2 
              ${isSelected 
                ? 'border-transparent shadow-xl scale-105' 
                : 'border-white/50 hover:border-white hover:shadow-lg hover:-translate-y-1 bg-white/40'
              }
            `}
          >
            <div className={`absolute inset-0 bg-gradient-to-br ${option.colorClass} transition-opacity duration-300 ${isSelected ? 'opacity-100' : 'opacity-0'}`} />
            <div className={`relative z-10 transition-colors duration-300 w-full flex flex-col items-center ${isSelected ? 'text-white' : 'text-gray-700'}`}>
              <div className={`w-16 h-16 rounded-full mb-3 flex items-center justify-center shrink-0 transition-all duration-300 ${isSelected ? 'bg-white/20' : 'bg-white/20 group-hover:bg-white'}`}>
                <Icon size={32} strokeWidth={1.5} />
              </div>
              <span className="font-semibold text-sm md:text-base leading-tight break-words max-w-full">{option.label}</span>
            </div>
            {isSelected && (
              <div className="absolute top-3 right-3 text-white animate-bounce">
                <CheckCircle2 size={20} />
              </div>
            )}
          </button>
        );
      };

      // --- MAIN APPLICATION ---

      const App = () => {
        const [viewMode, setViewMode] = useState('user'); // 'user' | 'admin'
        const [step, setStep] = useState('location'); // 'location' | 'feedback' | 'success'
        
        // Data Hooks
        const { locations, addLocation, deleteLocation } = useLocations();
        
        // User Flow State
        const [selectedLocationId, setSelectedLocationId] = useState('');
        const [customerName, setCustomerName] = useState('');
        const [selectedSourceId, setSelectedSourceId] = useState(null);
        const [otherText, setOtherText] = useState('');
        const [isSubmitting, setIsSubmitting] = useState(false);
        const [aiMessage, setAiMessage] = useState('');

        // Admin State
        const [adminPassword, setAdminPassword] = useState('');
        const [isAuthenticated, setIsAuthenticated] = useState(false);
        const [adminTab, setAdminTab] = useState('dashboard');
        const [submissions, setSubmissions] = useState([]);
        const [isLoadingSubmissions, setIsLoadingSubmissions] = useState(false);
        const [newLocationName, setNewLocationName] = useState('');
        const [dashboardFilter, setDashboardFilter] = useState('all');
        const [reportStart, setReportStart] = useState('');
        const [reportEnd, setReportEnd] = useState('');
        const [copied, setCopied] = useState(false);

        // --- HANDLERS ---

        const handleFeedbackSubmit = async () => {
          if (!customerName.trim()) { alert("Please enter your name first!"); return; }
          if (!selectedSourceId || !selectedLocationId) return;
          
          setIsSubmitting(true);
          
          const loc = locations.find(l => l.id === selectedLocationId);
          const opt = FEEDBACK_OPTIONS.find(o => o.id === selectedSourceId);
          const label = selectedSourceId === 'other' && otherText ? `Other: ${otherText}` : opt?.label || 'Unknown';
          
          const submissionData = {
            id: Date.now().toString(),
            customerName: customerName.trim(),
            locationId: selectedLocationId,
            locationName: loc?.name || 'Unknown',
            sourceId: selectedSourceId,
            sourceLabel: label,
            otherDetails: otherText,
            timestamp: new Date().toISOString()
          };

          // 1. Save to Google Sheets
          await saveToGoogleSheet(submissionData);

          // 2. Generate AI Message
          const msg = await generateThankYouMessage(label);
          setAiMessage(msg);
          
          setIsSubmitting(false);
          setStep('success');
        };

        const loadAdminData = async () => {
          if (!isAuthenticated) return;
          setIsLoadingSubmissions(true);
          const data = await fetchFromGoogleSheet();
          setSubmissions(data);
          setIsLoadingSubmissions(false);
        };

        useEffect(() => {
          if (viewMode === 'admin' && isAuthenticated) {
            loadAdminData();
          }
        }, [viewMode, isAuthenticated]);

        const handleAdminLogin = () => {
          if (adminPassword === '123456') {
            setIsAuthenticated(true);
            setAdminPassword('');
          } else {
            alert("Incorrect password");
          }
        };

        const handleSoftDelete = (id) => {
          if (window.confirm("This will remove the entry from your view temporarily, but IT WILL REMAIN in your Google Sheet. To delete permanently, please edit the Google Sheet directly.")) {
            setSubmissions(prev => prev.filter(s => s.id !== id));
          }
        };

        const copyCode = () => {
          navigator.clipboard.writeText(APPS_SCRIPT_CODE);
          setCopied(true);
          setTimeout(() => setCopied(false), 2000);
        };

        // --- COMPUTED DATA ---

        const filteredSubmissions = useMemo(() => {
          if (dashboardFilter === 'all') return submissions;
          return submissions.filter(s => s.locationId === dashboardFilter);
        }, [submissions, dashboardFilter]);

        const stats = useMemo(() => {
          const s = {};
          filteredSubmissions.forEach(sub => {
            s[sub.sourceLabel] = (s[sub.sourceLabel] || 0) + 1;
          });
          return Object.entries(s).sort((a, b) => b[1] - a[1]);
        }, [filteredSubmissions]);

        // --- RENDER: SUCCESS SCREEN ---
        if (step === 'success') {
          return (
            <div className="min-h-screen relative overflow-hidden bg-cover bg-center flex items-center justify-center p-4"
                 style={{ backgroundImage: 'url("https://images.unsplash.com/photo-1490481651871-ab68de25d43d?q=80&w=2070&auto=format&fit=crop")' }}>
              <div className="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
              <div className="glass-panel max-w-lg w-full rounded-3xl p-10 text-center relative z-10 animate-float shadow-2xl">
                <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600">
                   <ShoppingBag size={40} />
                </div>
                <h2 className="text-3xl md:text-4xl font-bold mb-4 text-gray-800 serif-font">Thank You!</h2>
                <div className="h-1 w-20 bg-pink-500 mx-auto mb-6 rounded-full"></div>
                <p className="text-xl text-gray-700 italic font-medium leading-relaxed mb-8">"{aiMessage}"</p>
                <button onClick={() => { setStep('location'); setSelectedSourceId(null); setOtherText(''); }} className="text-sm text-black hover:text-black-200 underline">Return to Home</button>
              </div>
            </div>
          );
        }

        // --- RENDER: ADMIN SCREEN ---
        if (viewMode === 'admin') {
          if (!isAuthenticated) {
            return (
              <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4 font-sans">
                <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
                  <div className="w-16 h-16 bg-gray-900 text-white rounded-full flex items-center justify-center mx-auto mb-6">
                    <Lock size={32} />
                  </div>
                  <h2 className="text-2xl font-bold mb-2">Admin Portal</h2>
                  <p className="text-gray-500 mb-6">Access dashboard and reports</p>
                  <input 
                    type="password" 
                    value={adminPassword} 
                    onChange={e => setAdminPassword(e.target.value)} 
                    placeholder="Enter Password"
                    className="w-full px-4 py-3 rounded-lg border-2 border-gray-200 mb-4 text-center focus:border-black outline-none transition-colors"
                    onKeyDown={e => e.key === 'Enter' && handleAdminLogin()}
                  />
                  <div className="flex gap-3">
                    <button onClick={() => setViewMode('user')} className="flex-1 py-3 text-gray-500 hover:bg-gray-100 rounded-lg">Cancel</button>
                    <button onClick={handleAdminLogin} className="flex-1 py-3 bg-black text-white rounded-lg hover:bg-gray-800">Login</button>
                  </div>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gray-100 flex flex-col md:flex-row font-sans text-gray-800">
              {/* Admin Sidebar */}
              <aside className="w-full md:w-64 bg-white border-r shadow-sm flex-none z-10 flex flex-col h-screen sticky top-0">
                <div className="p-6 border-b flex items-center justify-between">
                   <Logo />
                   <button onClick={() => setViewMode('user')} className="md:hidden p-2 text-gray-500"><X size={20} /></button>
                </div>
                <nav className="p-4 space-y-2 flex-1">
                  {[
                    { id: 'dashboard', label: 'Dashboard', icon: LayoutDashboard },
                    { id: 'feedbacks', label: 'Feedbacks', icon: MessageSquare },
                    { id: 'reports', label: 'Reports', icon: FileText },
                    { id: 'settings', label: 'Settings', icon: Settings },
                  ].map(tab => (
                    <button 
                      key={tab.id}
                      onClick={() => setAdminTab(tab.id)}
                      className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${adminTab === tab.id ? 'bg-black text-white' : 'text-gray-600 hover:bg-gray-100'}`}
                    >
                      <tab.icon size={18} /> {tab.label}
                    </button>
                  ))}
                </nav>
                <div className="p-4 border-t bg-gray-50">
                   <div className="text-xs text-gray-500 mb-2">Data Source: Google Sheets</div>
                   <button onClick={() => { setIsAuthenticated(false); setViewMode('user'); }} className="w-full flex items-center gap-2 text-red-600 hover:bg-red-50 px-4 py-2 rounded-lg transition-colors">
                    <LogOut size={16} /> Logout
                  </button>
                </div>
              </aside>

              {/* Admin Content */}
              <main className="flex-1 overflow-y-auto p-4 md:p-8">
                {/* Header Filter */}
                <div className="flex justify-between items-center mb-8">
                  <div>
                    <h2 className="text-2xl font-bold capitalize">{adminTab}</h2>
                    <p className="text-gray-500 text-sm">Real-time data from Google Sheets</p>
                  </div>
                  {adminTab !== 'settings' && (
                     <div className="flex gap-2">
                       <button onClick={loadAdminData} className="p-2 bg-white border rounded-lg hover:bg-gray-50 text-gray-600" title="Refresh Data">
                         <RefreshCw size={20} className={isLoadingSubmissions ? 'animate-spin' : ''} />
                       </button>
                       <select value={dashboardFilter} onChange={e => setDashboardFilter(e.target.value)} className="bg-white border rounded-lg px-4 py-2 shadow-sm text-sm outline-none focus:ring-1 focus:ring-black">
                        <option value="all">All Locations</option>
                        {locations.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}
                      </select>
                     </div>
                  )}
                </div>

                {isLoadingSubmissions && adminTab !== 'settings' ? (
                  <div className="flex justify-center py-20"><Loader2 className="animate-spin text-gray-400" size={40} /></div>
                ) : (
                  <>
                    {/* DASHBOARD */}
                    {adminTab === 'dashboard' && (
                      <div className="max-w-6xl mx-auto space-y-6 animate-fadeIn">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                          <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                             <p className="text-sm text-gray-500 mb-1">Total Submissions</p>
                             <p className="text-4xl font-bold">{filteredSubmissions.length}</p>
                          </div>
                          <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                             <p className="text-sm text-gray-500 mb-1">Top Source</p>
                             <p className="text-2xl font-bold truncate text-pink-600">{stats.length > 0 ? stats[0][0] : '-'}</p>
                          </div>
                          <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                             <p className="text-sm text-gray-500 mb-1">Latest Feedback</p>
                             <p className="text-sm font-medium mt-2">{filteredSubmissions[0] ? new Date(filteredSubmissions[0].timestamp).toLocaleString() : 'N/A'}</p>
                          </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                           <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 className="font-bold text-lg mb-6 flex items-center gap-2"><BarChart3 size={20} /> Sources Breakdown</h3>
                            <div className="space-y-4 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                              {stats.map(([label, count]) => (
                                <div key={label}>
                                  <div className="flex justify-between text-sm mb-2 font-medium">
                                    <span>{label}</span>
                                    <span className="text-gray-600">{count} ({Math.round((count / filteredSubmissions.length) * 100)}%)</span>
                                  </div>
                                  <div className="w-full bg-gray-100 rounded-full h-2">
                                    <div className="bg-gradient-to-r from-pink-500 to-purple-600 h-2 rounded-full" style={{ width: `${(count / filteredSubmissions.length) * 100}%` }}></div>
                                  </div>
                                </div>
                              ))}
                              {stats.length === 0 && <p className="text-gray-400 text-center py-4">No data available. Check Sheet Permissions.</p>}
                            </div>
                          </div>
                           <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
                            <h3 className="font-bold text-lg mb-6">Recent Comments</h3>
                            <div className="flex-1 overflow-y-auto pr-2 space-y-3 max-h-[400px] custom-scrollbar">
                              {filteredSubmissions.filter(s => s.otherDetails).slice(0, 10).map((sub, i) => (
                                <div key={i} className="p-4 bg-gray-50 rounded-xl border hover:border-gray-300 transition-colors">
                                  <div className="flex justify-between items-start mb-2">
                                    <span className="font-bold text-sm text-gray-900">{sub.customerName}</span>
                                    <span className="text-[10px] text-gray-400 bg-white px-2 py-1 rounded border">{new Date(sub.timestamp).toLocaleDateString()}</span>
                                  </div>
                                  <p className="text-sm text-gray-600 italic">"{sub.otherDetails}"</p>
                                </div>
                              ))}
                              {filteredSubmissions.filter(s => s.otherDetails).length === 0 && <p className="text-gray-400 text-center py-4">No specific comments found.</p>}
                            </div>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* FEEDBACKS TABLE */}
                    {adminTab === 'feedbacks' && (
                       <div className="bg-white rounded-2xl shadow-sm border overflow-hidden animate-fadeIn">
                          <div className="overflow-x-auto">
                            <table className="w-full text-left border-collapse">
                              <thead className="bg-gray-50 border-b">
                                <tr>
                                  <th className="p-4 font-semibold text-gray-600 text-sm">Date</th>
                                  <th className="p-4 font-semibold text-gray-600 text-sm">Customer</th>
                                  <th className="p-4 font-semibold text-gray-600 text-sm">Location</th>
                                  <th className="p-4 font-semibold text-gray-600 text-sm">Source</th>
                                  <th className="p-4 font-semibold text-gray-600 text-sm">Details</th>
                                  <th className="p-4 font-semibold text-gray-600 text-sm text-right">Action</th>
                                </tr>
                              </thead>
                              <tbody className="divide-y">
                                {filteredSubmissions.map((sub, idx) => (
                                  <tr key={idx} className="hover:bg-gray-50">
                                    <td className="p-4 text-sm text-gray-500">
                                      {new Date(sub.timestamp).toLocaleDateString()}
                                      <div className="text-xs text-gray-400">{new Date(sub.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                                    </td>
                                    <td className="p-4 font-medium text-sm">{sub.customerName}</td>
                                    <td className="p-4 text-sm text-gray-600">{sub.locationName}</td>
                                    <td className="p-4 text-sm"><span className="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-semibold">{sub.sourceLabel}</span></td>
                                    <td className="p-4 text-sm text-gray-500 max-w-xs truncate">{sub.otherDetails || '-'}</td>
                                    <td className="p-4 text-right">
                                      <button onClick={() => handleSoftDelete(sub.id)} className="text-gray-400 hover:text-red-600 p-2" title="Hide from view">
                                        <Trash2 size={16} />
                                      </button>
                                    </td>
                                  </tr>
                                ))}
                                {filteredSubmissions.length === 0 && <tr><td colSpan="6" className="p-8 text-center text-gray-400">No data found. Check Google Apps Script Deployment (Access: Anyone).</td></tr>}
                              </tbody>
                            </table>
                          </div>
                       </div>
                    )}

                    {/* SETTINGS (LOCATIONS & SCRIPT) */}
                    {adminTab === 'settings' && (
                       <div className="max-w-4xl mx-auto animate-fadeIn space-y-6">
                        
                        {/* Locations Card */}
                        <div className="bg-white p-6 rounded-2xl shadow-sm border">
                          <h3 className="font-bold text-lg mb-4">Add Store Location</h3>
                          <div className="flex gap-3 mb-6">
                            <input 
                              type="text" 
                              value={newLocationName} 
                              onChange={e => setNewLocationName(e.target.value)} 
                              placeholder="e.g. Hanamkonda" 
                              className="flex-1 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-black outline-none"
                            />
                            <button onClick={() => { if(newLocationName) { addLocation(newLocationName); setNewLocationName(''); } }} className="bg-black text-white px-6 rounded-xl font-medium hover:bg-gray-800 transition-colors">
                              Add
                            </button>
                          </div>
                          <div className="overflow-hidden border rounded-xl">
                            <table className="w-full text-left">
                              <thead className="bg-gray-50 border-b">
                                <tr>
                                  <th className="p-4 text-sm font-semibold text-gray-600">Location Name</th>
                                  <th className="p-4 text-sm font-semibold text-gray-600 text-right">Action</th>
                                </tr>
                              </thead>
                              <tbody className="divide-y">
                                {locations.map(loc => (
                                  <tr key={loc.id} className="hover:bg-gray-50">
                                    <td className="p-4 font-medium">{loc.name}</td>
                                    <td className="p-4 text-right">
                                      <button onClick={() => deleteLocation(loc.id)} className="text-red-500 hover:text-red-700 hover:bg-red-50 px-3 py-1.5 rounded text-sm transition-colors flex items-center gap-1 ml-auto">
                                        <Trash2 size={14} /> Remove
                                      </button>
                                    </td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        </div>
                       </div>
                    )}

                    {/* REPORTS */}
                    {adminTab === 'reports' && (
                      <div className="max-w-2xl mx-auto animate-fadeIn">
                         <div className="bg-white p-8 rounded-2xl shadow-sm border">
                            <div className="flex items-center gap-4 mb-6">
                              <div className="p-3 bg-green-100 text-green-700 rounded-xl"><FileText size={24} /></div>
                              <div>
                                <h3 className="font-bold text-lg">Export CSV Report</h3>
                                <p className="text-gray-500 text-sm">Download raw data processed from Google Sheets.</p>
                              </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4 mb-6">
                              <div>
                                <label className="block text-sm font-bold mb-2">Start Date</label>
                                <input type="date" value={reportStart} onChange={e => setReportStart(e.target.value)} className="w-full border rounded-xl px-4 py-3" />
                              </div>
                              <div>
                                <label className="block text-sm font-bold mb-2">End Date</label>
                                <input type="date" value={reportEnd} onChange={e => setReportEnd(e.target.value)} className="w-full border rounded-xl px-4 py-3" />
                              </div>
                            </div>

                            <button 
                              onClick={() => {
                                if(!reportStart || !reportEnd) return alert("Select dates.");
                                const start = new Date(reportStart).setHours(0,0,0,0);
                                const end = new Date(reportEnd).setHours(23,59,59,999);
                                const data = submissions.filter(s => {
                                  const t = new Date(s.timestamp).getTime();
                                  return t >= start && t <= end;
                                });
                                if(data.length === 0) return alert("No data in range.");
                                downloadCSV(data);
                              }}
                              className="w-full bg-black text-white py-4 rounded-xl font-bold hover:bg-gray-800 flex justify-center gap-2"
                            >
                              <Download size={20} /> Download CSV
                            </button>
                         </div>
                      </div>
                    )}
                  </>
                )}
              </main>
            </div>
          );
        }

        // --- RENDER: USER SCREEN ---
        return (
          <div className="min-h-screen relative bg-gray-50 font-sans">
             {/* Background Decor */}
            <div className="fixed inset-0 z-0 overflow-hidden pointer-events-none">
              <div className="absolute -top-[10%] -right-[10%] w-[50vw] h-[50vw] bg-pink-200/40 rounded-full blur-3xl mix-blend-multiply filter opacity-70 animate-blob"></div>
              <div className="absolute top-[20%] -left-[10%] w-[50vw] h-[50vw] bg-purple-200/40 rounded-full blur-3xl mix-blend-multiply filter opacity-70 animate-blob animation-delay-2000"></div>
              <div className="absolute -bottom-[10%] left-[20%] w-[50vw] h-[50vw] bg-yellow-200/40 rounded-full blur-3xl mix-blend-multiply filter opacity-70 animate-blob animation-delay-4000"></div>
            </div>

            {/* Header / Nav */}
            <div className="relative z-50 flex justify-between items-center p-6 container mx-auto max-w-6xl">
              <Logo />
              <button onClick={() => setViewMode('admin')} className="p-2 bg-white/50 hover:bg-white rounded-full transition-colors backdrop-blur-md border border-white/40 shadow-sm text-gray-700">
                <Lock size={18} />
              </button>
            </div>

            {/* Content */}
            <div className="relative z-10 container mx-auto px-4 py-4 md:py-8 max-w-6xl min-h-[80vh] flex flex-col">
               <header className="text-center mb-10 flex-none">
                <div className="inline-block p-3 rounded-full bg-white/80 shadow-sm mb-4 backdrop-blur-sm">
                  <span className="text-xs font-bold tracking-widest text-pink-600 uppercase px-2">
                    {step === 'location' ? 'Welcome, Kasam Fashions Private Limted' : locations.find(l => l.id === selectedLocationId)?.name}
                  </span>
                </div>
                <h1 className="text-4xl md:text-6xl font-bold text-gray-900 serif-font mt-2 leading-tight">
                  {step === 'location' ? (
                    <>Select Your <span className="text-transparent bg-clip-text bg-gradient-to-r from-pink-600 to-purple-600">Store Location</span></>
                  ) : (
                    <>We value your <span className="text-transparent bg-clip-text bg-gradient-to-r from-pink-600 to-purple-600">Feedback</span></>
                  )}
                </h1>
              </header>

              {step === 'location' && (
                <div className="flex-1 flex flex-col items-center justify-center animate-fadeIn pb-20">
                  <div className="w-full max-w-md bg-white/30 backdrop-blur-lg border border-white/50 rounded-3xl p-8 shadow-2xl">
                    <label className="block text-gray-700 font-semibold mb-4 text-center">Where are you shopping today?</label>
                    <div className="relative mb-8">
                      <select 
                        value={selectedLocationId}
                        onChange={(e) => setSelectedLocationId(e.target.value)}
                        className="w-full appearance-none bg-white/60 border border-white rounded-xl px-6 py-4 text-lg text-gray-800 shadow-sm focus:outline-none focus:ring-4 focus:ring-pink-200 transition-all cursor-pointer"
                      >
                        <option value="" disabled>Select a location...</option>
                        {locations.map(loc => (
                          <option key={loc.id} value={loc.id}>{loc.name}</option>
                        ))}
                      </select>
                      <div className="absolute right-5 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500"><ChevronDown size={24} /></div>
                    </div>
                    <button
                      onClick={() => { if(selectedLocationId) { setCustomerName(''); setStep('feedback'); } }}
                      disabled={!selectedLocationId}
                      className={`w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 transition-all duration-300 ${selectedLocationId ? 'bg-black text-white hover:scale-[1.02] shadow-xl' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}
                    >
                      Continue <ArrowRight size={20} />
                    </button>
                  </div>
                </div>
              )}

              {step === 'feedback' && (
                <div className="flex-1 animate-slideUp pb-20">
                  <button onClick={() => setStep('location')} className="mb-6 flex items-center gap-2 text-gray-500 hover:text-gray-900 transition-colors mx-auto md:mx-0">
                    <ArrowRight className="rotate-180" size={16} /> Change Location
                  </button>
                  
                  <div className="max-w-xl mx-auto mb-8">
                    <div className="relative">
                      <input 
                        type="text" 
                        value={customerName} 
                        onChange={(e) => setCustomerName(e.target.value)} 
                        placeholder="Enter your Name" 
                        className="w-full pl-12 pr-5 py-4 rounded-xl border-2 border-white/50 bg-white/40 backdrop-blur-md focus:border-pink-500 focus:bg-white/80 outline-none transition-all shadow-sm text-lg placeholder-gray-500" 
                        autoFocus 
                      />
                      <User className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500" size={24} />
                    </div>
                  </div>

                  <h3 className="text-2xl font-bold text-center mb-8 mt-2 serif-font text-gray-800">
                    <>How did you hear <span className="text-transparent bg-clip-text bg-gradient-to-r from-pink-600 to-purple-600">about us?</span></>
                  </h3>

                  <div className={`transition-all duration-500 ${!customerName.trim() ? 'opacity-50 pointer-events-none grayscale' : 'opacity-100'}`}>
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6 mb-12">
                      {FEEDBACK_OPTIONS.map((option) => (
                        <OptionCard key={option.id} option={option} isSelected={selectedSourceId === option.id} onClick={() => setSelectedSourceId(option.id)} />
                      ))}
                    </div>
                    {selectedSourceId === 'other' && (
                      <div className="max-w-xl mx-auto mb-10">
                        <input type="text" value={otherText} onChange={(e) => setOtherText(e.target.value)} placeholder="Please specify..." className="w-full px-5 py-4 rounded-xl border-2 border-indigo-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 outline-none transition-all shadow-sm text-lg" autoFocus />
                      </div>
                    )}
                    <div className="flex justify-center mb-8">
                      <button onClick={handleFeedbackSubmit} disabled={!selectedSourceId || isSubmitting || !customerName.trim()} className={`relative group flex items-center justify-center gap-3 px-10 py-4 rounded-full text-lg font-bold shadow-xl transition-all duration-300 ${(!selectedSourceId || !customerName.trim()) ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-gray-900 text-white hover:bg-black hover:scale-105'}`}>
                        {isSubmitting ? <><Loader2 className="animate-spin" /> Syncing to Cloud...</> : <>Submit Feedback <ArrowRight size={20} /></>}
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>



